---
toc: true
title: Motor Model Equations
---
<div class="hero">

The Physics
===========

The salient dynamics of an electric motor are governed by electromagnetic interactions and
mechanical dynamics of a spinning mass. We'll need circuit theory to describe the electrical
dynamics and understand magnetic moments to relate the electrical and mechanical dynamics.


Faraday's Law
-------------

The voltage across an inductor is given by Faraday's law of induction. The voltage is
proportional to the rate of change of the magnetic flux through the inductor. The magnetic
flux is proportional to the current flowing through the inductor. The magnetic flux can be 
generated either by the coil or by the permanent magnet. The effect on the phase windings 
is encapsulated in the magnetic flux linkage ${tex`\Psi_B`}; which also gives us an alternative
definition of inductance as the link between the magnetic flux generated by the inductor and
the current flowing through it. 

```tex
\begin{gather}
\tag{eq p-1}
V = N \frac{d\Phi_B}{dt} = \frac{d\Psi_B}{dt}

\\[2em]

\tag{eq p-2}
L = \frac{\Psi_{(I)}}{I}

\\[2em]

\tag{eq p-3}
\Psi_B = \Psi_{(I)} + \overrightarrow{\Psi_m} \bullet \hat{\theta} = \Psi_{(I)} + \Psi_m cos(\theta)
\end{gather}
```

Where the symbols mean:
* ${tex`t`} is time, of course.
* ${tex`V`} is the voltage generated across the inductor.
* ${tex`I`} is the current flowing through the inductor.
* ${tex`\Phi_B`} is the magnetic flux passing through the inductor.
* ${tex`\Psi_B = N \Phi_B`} is the magnetic flux linkage of the inductor; which is the 
magnetic flux passing through the coil surface multiplied by the number of turns in the coil.
* ${tex`N`} is the number of turns in the inductor winding.
* ${tex`L`} is the inductance of the inductor.
* ${tex`\Psi_{(I)}`} is the magnetic flux self-linkage generated by the current flowing through the inductor.
* ${tex`\Psi_m`} is the magnetic flux linkage due to the permanent magnet rotor.
* ${tex`\theta`} is the angle between the magnetic north of the magnet and the inductor winding.
* ${tex`\hat{\theta}`} is the unit vector in the direction of the inductor winding.

Rotational Mechanics
--------------------

We'll use a simple model for the mechanics, we assume a rotor with rotational inertia ${tex`J`},
a static friction torque ${tex`\tau_{friction}`} that always applies counter to the rotation, a
dynamic friction torque ${tex`\tau_{dynamic} = k_{\tau_{dynamic}} \omega`} proportional to the
rotational speed, and a load torque ${tex`\tau_{load}`} that is applied to the rotor externally.
We define the sign of the load torque in the same direction as the driving torque.

```tex
\begin{gather}
\tag{eq p-4}
\frac{d\omega}{dt} = \frac{1}{J} (\tau_{em} + \tau_{load} - \tau_{friction} - k_{\tau_{dynamic}} \omega)
\end{gather}
```

Torque Generation
-----------------

The driving torque ${tex`\tau_{em}`} is generated by the interaction of the magnetic fields of the
stator and the perpendicular magnetic moment of the rotor and vice versa. The torque on the rotor 
is equal and opposite to the torque on the stator. Our equations are simplest if we compute the 
torque on the stator, by calculating the magnetic moment of the windings. The torque is the cross 
product of the magnetic moment and the magnetic field.

```tex
\begin{gather}

\tag{eq p-5}
m_I = N I \hat{S}

\\[2em]
\tag{eq p-6}
\begin{split}
\tau_{em} &= \overrightarrow{m_I}\times \overrightarrow{B_m}  \\
&= N I (\hat{S} \times \overrightarrow{B_m}) \\
&= I (\hat{\theta} \times \overrightarrow{\Psi_m}) \\
&= I \Psi_m sin(\theta)
\end{split}
\end{gather}
```
Where the symbols mean:
* ${tex`\overrightarrow{m_I}`} is the magnetic moment of the inductor winding.
* ${tex`\overrightarrow{B_m}`} is the magnetic field of the permanent magnet rotor.
* ${tex`\hat{S}`} is the surface area of the inductor winding in the direction of the winding.



Motor equations
===============

We'll use a permanent magnet motor with 3 balanced phases. The motor is connected in a 
Y/star configuration and has 1 pole pair per phase. We'll simplify our model by assuming
no mutual induction between phases and no saturation effects in the iron core.

The motor electrical and mechanical dynamics can be described by the following equations:

```tex
\begin{align}

\tag{eq m-1}
\begin{bmatrix}V_a \\ V_b \\ V_c\end{bmatrix}
=
\frac{d}{dt}\Bigg(\begin{bmatrix}\Psi_a \\ \Psi_b \\ \Psi_c\end{bmatrix}\Bigg)
+ R_{phase} &\begin{bmatrix}I_a \\ I_b \\ I_c\end{bmatrix}

\\[3em]

\tag{eq m-2}
\begin{bmatrix}\Psi_a \\ \Psi_b \\ \Psi_c \end{bmatrix}
=
\Psi_m \begin{bmatrix}cos(\theta) \\ cos(\theta - 2\pi/3) \\ cos(\theta + 2\pi/3)\end{bmatrix}
+ L_{phase} &\begin{bmatrix}I_a \\ I_b \\ I_c\end{bmatrix}

\\[3em]

\tag{eq m-3}
\begin{split}
\frac{d}{dt}\Bigg(\begin{bmatrix}cos(\theta) \\ cos(\theta - 2\pi/3) \\ cos(\theta + 2\pi/3)\end{bmatrix}\Bigg)
&= \frac{d\theta}{dt} \begin{bmatrix}-sin(\theta) \\ -sin(\theta - 2\pi/3) \\ -sin(\theta + 2\pi/3)\end{bmatrix}
\\[2em]
\omega &= \frac{d\theta}{dt}
\\[2em]
\frac{d \overrightarrow{COS_{3ph}(\theta)}}{dt} &= -\omega \overrightarrow{SIN_{3ph}(\theta)}
\end{split}

\\[3em]

\tag{eq m-4}
\frac{\overrightarrow{V} - R_{phase} \overrightarrow{I} + \omega \Psi_m \overrightarrow{SIN_{3ph}(\theta)}}{L_{phase}} 

&= \frac{d\overrightarrow{I}}{dt}

\\[3em]

\tag{eq m-5}
\tau_{em} = -\Psi_m \begin{bmatrix}sin(\theta) \\ sin(\theta - 2\pi/3) \\ sin(\theta + 2\pi/3) \end{bmatrix}^T
\bullet &\begin{bmatrix}I_a \\ I_b \\ I_c\end{bmatrix}

\\[3em]

\tag{eq m-6}
0 = \begin{bmatrix}1 \\ 1 \\ 1\end{bmatrix}^T \bullet &\begin{bmatrix}I_a \\ I_b \\ I_c\end{bmatrix}

\\[3em]
\tag{eq m-7}
\frac{d\omega}{dt} = \frac{1}{J} (\tau_{em} + \tau_{load} - \tau_{friction} - k_{\tau_{dynamic}} \omega)

\end{align}


```

Where the symbols mean:
* ${tex`V_a, V_b, V_c`} are the voltages across the stator windings; with 
respect to the Neutral common node of the Y/star configuration.
* ${tex`I_a, I_b, I_c`} are the currents through the stator windings; positive 
from the Neutral to the phase connection.
* ${tex`R_{phase}`} is the phase winding resistance. We assume this is equal for
all phases.
* ${tex`L_{phase}`} is the phase winding inductance. This should actually be
an inductance matrix, but we assume it is diagonal for simplicity; and also equal
for all phases.
* ${tex`\Psi_a, \Psi_b, \Psi_c`} are the flux linkages of the stator windings. This
is ${tex`\Psi = N \Phi`} where ${tex`N`} is the number of turns in the winding and
${tex`\Phi`} is the magnetic flux through the winding.
* ${tex`\Psi_m`} is the magnetic flux linkage due to the permanent magnet rotor.
* ${tex`\theta`} is the rotor electrical angle. The North pole of the rotor magnet 
will be aligned with the winding for phase A when ${tex`\theta = 0`}.
* ${tex`\tau_{em}`} is the electromagnetic torque produced by the motor. The formula
computes the torque on the magnetic moments of the phase windings; the rotor torque
will be equal and opposite to this.
* ${tex`\omega = \frac{d\theta}{dt}`} is the rotor electrical angular velocity.
* ${tex`J`} is the rotor moment of inertia downscaled by pole pairs. We work in 
electrical radians so the physical coefficients have to be downscaled by the number
of pole pairs. For this motor, we have 1 pole pair per phase, so the coordinates match up.
* ${tex`\tau_{load}`} is the load torque on the rotor.
* ${tex`\tau_{friction}`} is the friction torque on the rotor.
* ${tex`\tau_{dynamic} = k_{\tau_{dynamic}} \omega`} is the dynamic friction torque on the rotor.


Radial Forces
-------------

The rotor will experience forces pushing it away from its axis of rotation when the magnetic
fields of the stator and rotor align. Under ideal operation the motor driver tries to keep
the stator field perpendicular to the rotor field to maximize its useful torque. The alignment
of the fields is a symptom of inefficiencies in the motor driver. We can also hear the motor
disturbances as noise, the typical high pitched whine of an electric motor. The other noise
source of the motor is the gear train which we cannot control electronically.

A magnetic moment in an external magnetic has potential energy ${tex`U`} and we can use the
same trick as in the torque equation to re-write it in terms of ${tex`\Psi_m`}. 
  
```tex
\begin{gather}
\tag{eq r-1}
\begin{split}
U &= -\overrightarrow{m_I} \bullet \overrightarrow{Bm}\\
&= -I (\hat{\theta} \bullet \overrightarrow{\Psi_m})
\end{split}
\end{gather}
```

The motor under simulation consists of a rotor with a relatively large magnet surrounding a 
stator core, with an air gap between them. The exact dynamic of the magnetic field is complex
so we must make some approximations. Because the air gap is small compared to the rotor magnet
we'll consider the magnetic field to fall-off from a monopole moment. For the distance we'll
use the maximum air gap anywhere along the circumference as the rotor wobbles around the stator.

```tex
\begin{gather}
\tag{eq r-2}
\begin{split}
\Psi_m &= \frac{\Psi_0 r_{gap}}{r + r_{gap}} \\
&= \Psi_0 \frac{1}{1 + r/r_{gap}} \\
&= \Psi_0 (1 + r/r_{gap})^{-1}
\end{split}
\end{gather}
```

To obtain the radially acting force we need to differentiate the potential energy with respect 
to the displacement distance ${tex`r`}. The force will be acting in the direction of the stator
winding; and in the equations below we'll consider ${tex`r`} to be aligned with the winding.


```tex
\begin{gather}
\tag{eq r-3}
\begin{split}
\overrightarrow{F_r} &= \nabla U \\
F_r &= \frac{dU}{dr} \\
&= \frac{d}{dr} \Big(-I \Psi_m cos(\theta)\Big) \\
&= -I \Psi_0 cos(\theta) \frac{d}{dr} (1 + r/r_{gap})^{-1} \\
&= -I \Psi_0 cos(\theta) \frac{-1}{(1 + r/r_{gap})^2} \frac{1}{r_{gap}} \\
&= I \frac{\Psi_0}{1+r/r_{gap}} cos(\theta) \frac{1}{r_{gap} (1 + r/r_{gap})} \\
&= I \Psi_m cos(\theta) \frac{1}{r + r_{gap}} 
\end{split}
\end{gather}
```

The forces are acting in the direction of each stator winding, the total force acting on the rotor
is the sum of the forces acting on each winding.

```tex
\begin{gather}
\tag{eq r-4}
\begin{split}
F_r \hat{x} &= \Big(\overrightarrow{I} \cdot \overrightarrow{COS_3{ph}(0)}\Big) \Psi_m \bullet \overrightarrow{COS_{3ph}(\theta)} \frac{1}{r + r_{gap}} \\
F_r \hat{y} &= \Big(\overrightarrow{I} \cdot \overrightarrow{SIN_3{ph}(0)}\Big) \Psi_m \bullet \overrightarrow{COS_{3ph}(\theta)} \frac{1}{r + r_{gap}} \\

\end{split}
\end{gather}
```

Where the symbols mean:
* ${tex`x`} is the radial displacement on the x axis.
* ${tex`y`} is the radial displacement on the y axis.
* ${tex`\cdot`} represents term by term multiplication (we use it to get the projection on each axis).
* ${tex`r = \sqrt{x^2 + y^2}`} is the radial displacement anywhere around the circumference.
* ${tex`r_{gap}`} is default air gap between the rotor and stator.
* ${tex`\Psi_0`} is the magnetic flux linkage at the rotor surface with the default air gap.
* ${tex`F_r`} is the radial force acting on the rotor.

We'll use the power equations ${tex`P = F \nu = I V`} to get the back emf formula.


```tex
\begin{gather}
\tag{eq r-5}
\begin{split}
P_r &= \nu F_r \\
&= \nu I \Psi_m cos(\theta) \frac{1}{r + r_{gap}} \\
&= V_r I
\end{split}

\\[2em]

\tag{eq r-6}
\overrightarrow{V_r} = \Big(\nu \overrightarrow{COS_{3ph}(\theta_{\nu})} \Big) \cdot \Big(\Psi_m \overrightarrow{COS_{3ph}(\theta)} \frac{1}{r + r_{gap}}\Big)
\end{gather}

```

Where the symbols mean:
* ${tex`P_r`} is the power dissipated by the radial force acting on the rotor.
* ${tex`V_r`} is the back emf generated by the radial displacement.
* ${tex`\nu`} is the radial velocity of the rotor.
* ${tex`\theta_{\nu}`} is the angle of the radial velocity vector.


Equations with Radial Displacement
==================================

We can now gather all the equations we need to simulate the motor dynamics including the noisy
radial displacement, which are a symptom of innefficiencies in the motor driver. Include the
radial back emf in the electrical differential equation ${tex`\text{(eq m-4)}`}. We can copy
the torque equation ${tex`\text{(eq m-5)}`} and the rotor dynamics ${tex`\text{(eq m-7)}`}.
Finally add the partial axial dynamics for scalar axial velocity ${tex`\nu`}. I predict we
should be able to hear the motor commutation noise if we play back ${tex`\nu`} as audio.

```tex
\begin{gather}
\tag{eq r-2}
\Psi_m = \Psi_0 (1 + r/r_{gap})^{-1}

\\[3em]

\tag{eq r-7}
\begin{split}
L_{phase} \frac{d\overrightarrow{I}}{dt} &=
\overrightarrow{V} - R_{phase} \overrightarrow{I} \\ 
&+ \omega \Psi_m \overrightarrow{SIN_{3ph}(\theta)} \\
&+ \frac{\nu}{r + r_{gap}} \Psi_m \overrightarrow{COS_{3ph}(\theta_{\nu})} \cdot \overrightarrow{COS_{3ph}(\theta)}
\end{split}
\\[3em]

\tag{eq r-8}
\tau_{em} = -\Psi_m \overrightarrow{SIN_{3ph}(\theta)} \bullet \overrightarrow{I}

\\[3em]

\tag{eq r-9}
\frac{d\omega}{dt} = \frac{1}{J} (\tau_{em} + \tau_{load} - \tau_{friction} - k_{\tau_{dynamic}} \omega)

\\[3em]

\tag{eq r-10}
\frac{d\nu}{dt} = -\frac{1}{m} \Psi_m \frac{\overrightarrow{I} \bullet \overrightarrow{COS_{3ph}(\theta)}}{r + r_{gap}}

\end{gather}



```


Electrical Connections
======================

The motor is connected in a Y/star configuration. Each phase is connected to a half-bridge between
two N-channel MOSFETs.

Phase to Phase Voltages
-----------------------

We can only control the phase to phase voltages ${tex`V_{ab}, V_{bc}, V_{ca}`} which
are the differences between the phase voltages. The balanced nature allows us to recover
the phase voltages from the phase to phase voltages:
  
```tex
\begin{gather}
\tag{eq v-1}
&\begin{bmatrix}V_{ab} \\ V_{bc} \\ V_{ca}\end{bmatrix}
=
\begin{bmatrix}V_a - V_b \\ V_b - V_c \\ V_c - V_a\end{bmatrix}

\\[2em]

\tag{eq v-2}
&V_a + V_b + V_c = 0

\\[2em]

\tag{eq v-3}
&\begin{split}
V_{ab} - V_{ca} &= V_a - V_b - (V_c - V_a) \\
&= 2V_a - V_b - V_c \\
&= 3V_a
\end{split}

\\[2em]

\tag{eq v-4}
&\begin{bmatrix}V_a \\ V_b \\ V_c\end{bmatrix}
=
\begin{bmatrix}(V_{ab} - V_{ca})/3 \\ (V_{bc} - V_{ab})/3 \\ (V_{ca} - V_{bc})/3\end{bmatrix}
\end{gather}
```

MOSEFT Connections
------------------

The phases are connected to MOSFET half-bridges which can be controlled by PWM signals. At any
instant the MOSFET bridges are either turned on or off; however when turned off the MOSFET body
diode will allow current to flow in the reverse direction, from source to drain. (This diode
effect is present in all MOSFETs due to their construction). In the cases where the MOSFET is
turned on, it will act as a resistance with low resistance ${tex`R_{fet}`}. When the MOSFET is
turned off but conducting through the diode, it will act as a diode with a voltage drop of
${tex`V_{diode}`}.

Current circulating in the inductive phase windings will continue circulating when we switch the
MOSFET state. Because of the arrangement of the MOSFET connections, the current will always find
a path between the phases. We can determine which diode is conducting by the current flowing in
each phase. If it's positive current (which we define as current flowing out of the phase winding), 
the HIGH side diode will conduct, while if it's negative the LOW side diode will conduct.


Overall, we either short the phase to phase connection, or present the battery voltage. The MOSFETs
will have voltage drop either from the resistance or the body diode depending on which is conducting.
The voltage drop across the U to V phase are given below, and the rest can be derived by symmetry:

[TODO] this gotta be fixed.
```tex
\begin{gather}
\tag{eq v-5}
V_{ab} = \begin{cases}
VCC + 2*V_{diode} &\text{if A is floating and } I_a > 0 \text{ and B is floating and } I_b < 0 \\
VCC + V_{diode} - R_{fet} I_b &\text{if A is floating and } I_a > 0 \text{ and B is low} \\
VCC + V_{diode} - R_{fet} I_a &\text{if A is high and B is floating and } I_b < 0 \\
VCC - R_{fet} (I_a + I_b) &\text{if A is high and B is low} \\
0 - R_{fet} (I_a + I_b) &\text{if A and B are both low or high} \\
-VCC - R_{fet} (I_a + I_b) &\text{if A is low and B is high} \\
-VCC - V_{diode} - R_{fet} I_a &\text{if A is low and B is floating and } I_b > 0 \\
-VCC - V_{diode} - R_{fet} I_b &\text{if A is floating and } I_a < 0 \text{ and B is high} \\
-VCC - 2*V_{diode} &\text{if A is floating and } I_a < 0 \text{ and B is floating and } I_b > 0

\end{cases}
\end{gather}
```

Where the symbols mean:
* ${tex`V_{ab}, V_{bc}, V_{ca}`} are the voltages applied between each pair of phases.
* ${tex`VCC`} is the battery voltage.
* ${tex`V_{diode}`} is the voltage drop across the MOSFET body diode.
* ${tex`R_{fet}`} is the resistance of the MOSFET when turned on.


</div>
